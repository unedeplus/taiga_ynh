#!/bin/bash

source /usr/share/yunohost/helpers
source _common.sh

#=================================================
# INITIALIZE AND STORE SETTINGS
#=================================================
ynh_script_progression "Initializing installation parameters..."

# Generate secret key and RabbitMQ password
secret_key=$(ynh_string_random --length=50)
rabbitmq_pwd=$(ynh_string_random --length=32)
rabbitmq_user=$app

# Store settings
ynh_app_setting_set --key=secret_key --value="$secret_key"
ynh_app_setting_set --key=rabbitmq_user --value="$rabbitmq_user"
ynh_app_setting_set --key=rabbitmq_pwd --value="$rabbitmq_pwd"

#=================================================
# DOWNLOAD, CHECK AND UNPACK SOURCE
#=================================================
ynh_script_progression "Setting up source files..." --weight=5

# Download backend
ynh_setup_source --dest_dir="$install_dir/taiga-back" --source_id="main"

# Download frontend  
ynh_setup_source --dest_dir="$install_dir/taiga-front" --source_id="front"

#=================================================
# SPECIFIC SETUP
#=================================================
ynh_script_progression "Configuring RabbitMQ..." --weight=2

# Create RabbitMQ user and vhost
rabbitmqctl add_user "$rabbitmq_user" "$rabbitmq_pwd" 2>&1 || true
rabbitmqctl add_vhost "$app" 2>&1 || true
rabbitmqctl set_permissions -p "$app" "$rabbitmq_user" ".*" ".*" ".*" 2>&1 || true

#=================================================
# PYTHON DEPENDENCIES
#=================================================
ynh_script_progression "Installing Python dependencies..." --weight=20

# Create virtualenv
python3 -m venv "$install_dir/venv"

# Install Python packages
"$install_dir/venv/bin/pip" install --upgrade pip wheel setuptools
"$install_dir/venv/bin/pip" install -r "$install_dir/taiga-back/requirements.txt"
"$install_dir/venv/bin/pip" install gunicorn gevent

#=================================================
# ADD TAIGA CONFIGURATION
#=================================================
ynh_script_progression "Adding Taiga configuration files..." --weight=1

# Backend configuration
ynh_config_add --template="local.py" --destination="$install_dir/taiga-back/settings/local.py"

# Set proper permissions on config
chmod 600 "$install_dir/taiga-back/settings/local.py"

#=================================================
# BUILD FRONTEND
#=================================================
ynh_script_progression "Building frontend..." --weight=10

# Ensure Node.js 18 is active (node-sass incompatible with v22+)
# Remove /usr/local nodejs that shadows the system package
rm -f /usr/local/bin/node /usr/local/bin/npm /usr/local/bin/npx /usr/local/bin/corepack
rm -rf /usr/local/lib/node_modules

# Install Node.js 18 and npm if not present
if ! dpkg -l | grep -q "^ii.*nodejs.*18"; then
    ynh_script_progression "Installing Node.js $nodejs_version from NodeSource..."
    curl -fsSL https://deb.nodesource.com/setup_${nodejs_version}.x | bash -
    apt-get install -y nodejs
fi

# Ensure npm is installed (separate package in Debian)
if ! command -v npm &> /dev/null; then
    apt-get install -y npm
fi

# Verify we have Node.js 18 and npm
node_version=$(node --version | cut -d'v' -f2 | cut -d'.' -f1)
if [[ "$node_version" != "18" ]]; then
    ynh_die "Node.js 18 is required but version $node_version is active"
fi
if ! command -v npm &> /dev/null; then
    ynh_die "npm is required but not found in PATH"
fi

# Set ownership of install directory so app user can build
chown -R "$app:$app" "$install_dir"

# Ensure swap space exists for memory-intensive npm install
swap_needed=false
if [[ $(swapon --show | wc -l) -eq 0 ]]; then
    ynh_script_progression "Creating temporary swap file (2GB) for build..."
    swap_needed=true
    fallocate -l 2G /tmp/taiga_swap || dd if=/dev/zero of=/tmp/taiga_swap bs=1M count=2048
    chmod 600 /tmp/taiga_swap
    mkswap /tmp/taiga_swap
    swapon /tmp/taiga_swap
fi

# Build frontend
ynh_script_progression "Building frontend..."

pushd "$install_dir/taiga-front"
    # Check if pre-built assets package exists
    PREBUILT_PACKAGE="/tmp/taiga-front-prebuilt.tar.gz"
    
    if [ -f "$PREBUILT_PACKAGE" ]; then
        # Use pre-built assets if available
        ynh_script_progression "Using pre-built frontend assets from $PREBUILT_PACKAGE"
        # Extract to parent directory, which will create taiga-front/dist structure
        tar xzf "$PREBUILT_PACKAGE" -C "$install_dir"
        chown -R "$app:$app" "$install_dir"
    else
        # Build from source (requires 8GB+ RAM)
        ynh_script_progression "Building from source (requires 8GB+ RAM)..."
        
        export NODE_OPTIONS="--max-old-space-size=6144"
        
        # Delete package-lock.json for flexible dependency resolution
        rm -f package-lock.json
        
        # Try to install dependencies with aggressive memory management
        timeout 1800 sudo -u "$app" NODE_OPTIONS="$NODE_OPTIONS" npm install \
            --force \
            --no-audit \
            --no-fund \
            --loglevel=error \
            --legacy-peer-deps \
            --maxsockets=1 \
            --prefer-offline || {
            echo ""
            echo "======================================================================="
            echo "INSTALLATION FAILED: Insufficient memory for npm install"
            echo "======================================================================="
            echo ""
            echo "Your server needs at least 8GB RAM to build Taiga frontend."
            echo ""
            echo "WORKAROUND OPTIONS:"
            echo ""
            echo "1. Build on another machine with 8GB+ RAM:"
            echo "   - Run: bash build-frontend-external.sh"
            echo "   - Upload: scp taiga-front-*-dist.tar.gz admin@$domain:/tmp/taiga-front-prebuilt.tar.gz"
            echo "   - Retry installation"
            echo ""
            echo "2. Extract from Docker image:"
            echo "   - Run: bash extract-frontend-docker.sh"
            echo "   - Upload: scp taiga-front-*-docker-dist.tar.gz admin@$domain:/tmp/taiga-front-prebuilt.tar.gz"
            echo "   - Retry installation"
            echo ""
            echo "3. Temporarily upgrade server RAM (recommended):"
            echo "   - Add 4GB RAM to reach 8GB total"
            echo "   - Install Taiga"
            echo "   - Downgrade RAM after installation"
            echo ""
            echo "======================================================================="
            ynh_die "Frontend build failed. See above for workarounds."
        }
        
        # Build
        ynh_script_progression "Compiling frontend assets..."
        sudo -u "$app" NODE_OPTIONS="$NODE_OPTIONS" npm run build || ynh_die "Frontend build failed"
        
        unset NODE_OPTIONS
    fi
popd

# Remove temporary swap if we created it
if [[ "$swap_needed" == "true" ]]; then
    ynh_script_progression "Removing temporary swap file..."
    swapoff /tmp/taiga_swap
    rm -f /tmp/taiga_swap
fi

# Copy built frontend to final location
mkdir -p "$install_dir/front-dist"
cp -r "$install_dir/taiga-front/dist/"* "$install_dir/front-dist/"

# Frontend configuration
ynh_config_add --template="conf.json" --destination="$install_dir/front-dist/conf.json"

#=================================================
# INITIALIZE DATABASE
#=================================================
ynh_script_progression "Initializing database..." --weight=5

pushd "$install_dir/taiga-back"
    # Run migrations
    sudo -u "$app" "$install_dir/venv/bin/python" manage.py migrate --noinput
    
    # Collect static files
    sudo -u "$app" "$install_dir/venv/bin/python" manage.py collectstatic --noinput
    
    # Compile messages
    sudo -u "$app" "$install_dir/venv/bin/python" manage.py compilemessages
    
    # Create admin user
    sudo -u "$app" "$install_dir/venv/bin/python" manage.py createsuperuser \
        --noinput --username="$admin" --email="$admin@$domain" || true
    
    # Change admin password
    sudo -u "$app" "$install_dir/venv/bin/python" manage.py changepassword "$admin" <<EOF
$password
$password
EOF
popd

#=================================================
# CREATE DATA DIRECTORIES
#=================================================
ynh_script_progression "Creating data directories..."

# Create media directory
mkdir -p "$data_dir/media"

#=================================================
# CREATE LOG DIRECTORY
#=================================================
mkdir -p "/var/log/$app"
chown -R "$app:$app" "/var/log/$app"

#=================================================
# SYSTEM CONFIGURATION
#=================================================
ynh_script_progression "Adding system configurations related to $app..." --weight=1

# Create systemd services
ynh_config_add_systemd --service="$app" --template="systemd.service"
ynh_config_add_systemd --service="$app-celery" --template="systemd-celery.service"

# Add nginx configuration
ynh_config_add_nginx

# Set permissions
chown -R "$app:$app" "$install_dir"
chown -R "$app:$app" "$data_dir"
chmod 750 "$install_dir"
chmod 750 "$data_dir"

#=================================================
# START SYSTEMD SERVICE
#=================================================
ynh_script_progression "Starting systemd services..." --weight=1

# Start and enable services
ynh_systemctl --service="$app" --action="enable"
ynh_systemctl --service="$app" --action="start" --wait_until="Listening at"
ynh_systemctl --service="$app-celery" --action="enable"
ynh_systemctl --service="$app-celery" --action="start"

#=================================================
# END OF SCRIPT
#=================================================
ynh_script_progression "Installation of $app completed" --last
