#!/bin/bash

source /usr/share/yunohost/helpers
source _common.sh

#=================================================
# INITIALIZE AND STORE SETTINGS
#=================================================
ynh_script_progression "Initializing installation parameters..."

# Generate secret key and RabbitMQ password
secret_key=$(ynh_string_random --length=50)
rabbitmq_pwd=$(ynh_string_random --length=32)
rabbitmq_user=$app

# Store settings
ynh_app_setting_set --key=secret_key --value="$secret_key"
ynh_app_setting_set --key=rabbitmq_user --value="$rabbitmq_user"
ynh_app_setting_set --key=rabbitmq_pwd --value="$rabbitmq_pwd"

#=================================================
# DOWNLOAD, CHECK AND UNPACK SOURCE
#=================================================
ynh_script_progression "Setting up source files..." --weight=5

# Download backend
ynh_setup_source --dest_dir="$install_dir/taiga-back" --source_id="main"

# Download frontend  
ynh_setup_source --dest_dir="$install_dir/taiga-front" --source_id="front"

#=================================================
# SPECIFIC SETUP
#=================================================
ynh_script_progression "Configuring RabbitMQ..." --weight=2

# Create RabbitMQ user and vhost
rabbitmqctl add_user "$rabbitmq_user" "$rabbitmq_pwd" 2>&1 || true
rabbitmqctl add_vhost "$app" 2>&1 || true
rabbitmqctl set_permissions -p "$app" "$rabbitmq_user" ".*" ".*" ".*" 2>&1 || true

#=================================================
# PYTHON DEPENDENCIES
#=================================================
ynh_script_progression "Installing Python dependencies..." --weight=20

# Create virtualenv
python3 -m venv "$install_dir/venv"

# Install Python packages
"$install_dir/venv/bin/pip" install --upgrade pip wheel setuptools
"$install_dir/venv/bin/pip" install -r "$install_dir/taiga-back/requirements.txt"
"$install_dir/venv/bin/pip" install gunicorn gevent

#=================================================
# ADD TAIGA CONFIGURATION
#=================================================
ynh_script_progression "Adding Taiga configuration files..." --weight=1

# Backend configuration
ynh_config_add --template="local.py" --destination="$install_dir/taiga-back/settings/local.py"

# Set proper permissions on config
chmod 600 "$install_dir/taiga-back/settings/local.py"

#=================================================
# BUILD FRONTEND
#=================================================
ynh_script_progression "Building frontend..." --weight=10

# Install Node.js from NodeSource
if ! command -v node &> /dev/null || [[ $(node --version | cut -d'v' -f2 | cut -d'.' -f1) -lt 18 ]]; then
    ynh_script_progression "Installing Node.js $nodejs_version..."
    curl -fsSL https://deb.nodesource.com/setup_${nodejs_version}.x | bash -
    ynh_apt install nodejs
fi

# Build frontend
pushd "$install_dir/taiga-front"
    sudo -u "$app" npm ci
    sudo -u "$app" npm run build
popd

# Copy built frontend to final location
mkdir -p "$install_dir/front-dist"
cp -r "$install_dir/taiga-front/dist/"* "$install_dir/front-dist/"

# Frontend configuration
ynh_config_add --template="conf.json" --destination="$install_dir/front-dist/conf.json"

#=================================================
# INITIALIZE DATABASE
#=================================================
ynh_script_progression "Initializing database..." --weight=5

pushd "$install_dir/taiga-back"
    # Run migrations
    sudo -u "$app" "$install_dir/venv/bin/python" manage.py migrate --noinput
    
    # Collect static files
    sudo -u "$app" "$install_dir/venv/bin/python" manage.py collectstatic --noinput
    
    # Compile messages
    sudo -u "$app" "$install_dir/venv/bin/python" manage.py compilemessages
    
    # Create admin user
    sudo -u "$app" "$install_dir/venv/bin/python" manage.py createsuperuser \
        --noinput --username="$admin" --email="$admin@$domain" || true
    
    # Change admin password
    sudo -u "$app" "$install_dir/venv/bin/python" manage.py changepassword "$admin" <<EOF
$password
$password
EOF
popd

#=================================================
# CREATE DATA DIRECTORIES
#=================================================
ynh_script_progression "Creating data directories..."

# Create media directory
mkdir -p "$data_dir/media"

#=================================================
# CREATE LOG DIRECTORY
#=================================================
mkdir -p "/var/log/$app"
chown -R "$app:$app" "/var/log/$app"

#=================================================
# SYSTEM CONFIGURATION
#=================================================
ynh_script_progression "Adding system configurations related to $app..." --weight=1

# Create systemd services
ynh_config_add_systemd --service="$app" --template="systemd.service"
ynh_config_add_systemd --service="$app-celery" --template="systemd-celery.service"

# Add nginx configuration
ynh_config_add_nginx

# Set permissions
chown -R "$app:$app" "$install_dir"
chown -R "$app:$app" "$data_dir"
chmod 750 "$install_dir"
chmod 750 "$data_dir"

#=================================================
# START SYSTEMD SERVICE
#=================================================
ynh_script_progression "Starting systemd services..." --weight=1

# Start and enable services
ynh_systemctl --service="$app" --action="enable"
ynh_systemctl --service="$app" --action="start" --wait_until="Listening at"
ynh_systemctl --service="$app-celery" --action="enable"
ynh_systemctl --service="$app-celery" --action="start"

#=================================================
# END OF SCRIPT
#=================================================
ynh_script_progression "Installation of $app completed" --last
